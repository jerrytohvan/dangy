---
title: "PROJECT"
author: "Jerry Tohvan, Ang Kah Eng, Terence Tan, Jerry Tohvan"
date: "1/14/2019"
output: 
  html_notebook:
    number_section: yes
    theme: flatly
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
  word_document:
    toc: yes
---

Setup R notebook Environment
```{r setup, include=TRUE, eval=TRUE,message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)
Sys.setlocale("LC_CTYPE", "en_US.UTF-8")
```

#Package load for Project
```{r}
packages = c("lubridate","stpp","sp","sf","tidyverse","tmap","rjson", "rgdal", "geojsonio", "GISTools",'spatialEco', "raster","dplyr","spdep","rpanel","rgl","maptools","r2d3","gganimate") 
for (p in packages){
  if(!require(p, character.only = T)){
      install.packages(p) 
  } 
  library(p,character.only = T) 
}
```

#Importing Taiwan GDAM Subzone
Shapefile Object with Spatial data
Import data for past 12 years

Requires translation of chinese character independetly (https://stat.ethz.ch/pipermail/r-sig-geo/2009-March/005323.html)

Taiwan follows EPSG 3826 (http://spatialreference.org/ref/epsg/twd97-tm2-zone-121/)
```{r}
taiwan_ts_map_sp <- readOGR(dsn = "data/TAIWAN_TOWNSHIP", layer = "TOWN_MOI_1071226", stringsAsFactors=TRUE)

taiwan <- readShapePoly("data/taiwan_data/COUNTY_MOI_1070516.shp")
taiwan@proj4string<- CRS( "+init=epsg:3826 +proj=longlat +ellps=WGS84 +no_defs")
taiwan.union <- aggregate(taiwan)


df_dengue <- jsonlite::fromJSON("data/dengue_case.json") %>% 
  filter(as.Date(Onset_day) >= "2016-01-01" & as.Date(Onset_day)< "2017-01-01")

# Check for NA values for coordinates
 sum(is.na(df_dengue$Minimum_statistical_area_center_point_X))
 sum(is.na(df_dengue$Minimum_statistical_area_center_point_Y))
 df_dengue<- df_dengue[!is.na(df_dengue$Minimum_statistical_area_center_point_X),]
 df_dengue<- df_dengue[!(df_dengue$Minimum_statistical_area_center_point_X == 'None'),]
 
 # Type conversion
 df_dengue[, c(10,11,19,23,24)] <- sapply(df_dengue[, c(10,11,19,23,24)], as.numeric)
 
  # Transform into SF object
 sf_dengue <- st_as_sf(df_dengue, 
                       coords = c("Minimum_statistical_area_center_point_X",
                                  "Minimum_statistical_area_center_point_Y"),
                        crs = "+init=epsg:3826 +proj=longlat +ellps=WGS84 +no_defs",na.fail=FALSE)
sf_dengue <- na.omit(sf_dengue)
sf_dengue <- as(sf_dengue, 'Spatial')
```

Map name dict to map
```{r}


tmap_mode("plot")
map <- tm_shape(taiwan_ts_map_sp)+
      tm_polygons('TOWNENG')+
       tm_borders(col = "grey40",alpha=0.5)+
  tm_view(alpha = 1)+
  tm_layout(basemaps = c('OpenStreetMap'))+
  tm_shape(sf_dengue)+
  tm_bubbles(col ="red",size = 0.1)

map 
```


```{r}
projection(taiwan_ts_map_sp) <- sf_dengue@proj4string
taiwan_ts_map_sp@data$poly.ids <- 1:nrow(taiwan_ts_map_sp)

#join poly and points
pts.poly <- point.in.poly(sf_dengue, taiwan_ts_map_sp)
#assign unique id per poly, full info
```


#STPP
https://www.youtube.com/watch?v=V3BWJLg0L5w
https://rpubs.com/frajaroco/333456
package: lubridate
```{r}

#https://medium.com/@yenishrepublic/how-can-i-generate-a-triangular-network-with-r-ce6e20b13221

filter_dengue_time <- sf_dengue@data %>%
  mutate(DAY_ORDER = yday(as.Date(Onset_day)))
dengue_3d <- as.3dpoints(sf_dengue@coords[,1],sf_dengue@coords[,2],filter_dengue_time$DAY_ORDER)



```

Static two-panel plot of data from the 2016 Dengue case in the county of Taiwan,
```{r}

counter=c()
max=1
prev=1
for(i in 1:length(taiwan.union@polygons[[1]]@Polygons)){
 max=max(c(length(taiwan.union@polygons[[1]]@Polygons[[i]]@coords[,1]),max))
 if(max>prev){
 counter=i
 }
 prev=max
}
taiwan@proj4string
taiwan_main <- taiwan.union@polygons[[1]]@Polygons[[counter]]@coords
plot(taiwan_main,asp=1,type="l")

plot(dengue_3d,s.region=taiwan_main,col="red",type="projection")
plot(dengue_3d ,s.region=taiwan_main,col="red",type="scatter" )
plot(dengue_3d,s.region=taiwan_main,type="mark")

```



An alternative static display in which the time is treated as a quantitative mark attached to each location, and the locations are plotted with the size and/or color of the plotting symbol determined by the value of the mark. 
```{r}
plot(dengue_3d, s.region = taiwan_main, pch = 19, mark = TRUE)
```

Animation of a space-time point pattern. The approximate running time of the animation (in seconds) is set through the runtime parameter, although the animation may actually run more slowly than this, depending on the size of the data-set and the hardware con???guration. If runtime = NULL, the animation is displayed as quickly as the data-set and hardware con???guration allow. 
```{r}
#stan(dengue_3d, bgpoly = taiwan_main, bgframe = TRUE)

```



# Analyzing space-time point process data

the space-time inhomogeneous pair correlation function and K-function can be used as measure of spatio-temporal clustering/regularity and as measure of spatio-temporal interaction (Gabriel and Diggle 2009; Møller and Ghorbani
2012).

##Space-time inhomogeneous K-function (STIK)
For a second-order intensity reweighted stationary, isotropic spatio-temporal point process,
the space-time inhomogeneous K-function (STIK-function). STIK function characterizes the second-order properties of a second-order intensity reweighted stationary spatio-temporal point process, and can be used as a measure of spatiotemporal aggregation or regularity
```{r}
#https://d4tagirl.com/2017/05/how-to-plot-animated-maps-with-gganimate

library(maps)
# library(tibble)
# library(lubridate)
library(ggplot2)    
library(ggmap)
library(gganimate)
# library(gifski)

# taiwan_map <- fortify(taiwan_ts_map_sp)
taiwan_map <- fortify(taiwan)
datetime <- as.data.frame(dengue_3d[,3])
taiwan_plot <- ggplot(data=taiwan_map, aes(x = long, y = lat, group=group))+
  geom_path() + 
  coord_map()

dengue_points <- as.data.frame(sf_dengue) %>%
   dplyr::select(Onset_day, coords.x1,coords.x2)
dengue_points$Onset_day <- as.Date(dengue_points$Onset_day)
dengue_points <- dengue_points%>%
  mutate(months=as.numeric(format(Onset_day, "%m")))
date_dengue <- as.data.frame(as.Date(dengue_points$Onset_day))
date_dengue$coords.x1 <- 0
date_dengue$coords.x2 <- 0
colnames(date_dengue) <- c("start_date","coords.x1","coords.x2")
start_date <- date_dengue[1,]

date_dengue<-date_dengue[!(date_dengue$start_date==start_date$start_date),]
date_dengue<-unique(date_dengue)


#========== new API ========
# map <-taiwan_plot+
#    geom_point(mapping = aes(x = coords.x1, y = coords.x2),  data = dengue_points,  colour = 'red', alpha = .05, inherit.aes = FALSE)
# ani<- map + transition_states(months)+
#   labs(title = 'Month: {closest_state}')
# animate(ani, renderer = ffmpeg_renderer())
#========== new API ========

#========== old API ========
map <-taiwan_plot+
   geom_point(mapping = aes(x = coords.x1, y = coords.x2, frame=Onset_day),  data = dengue_points,  colour = 'red', alpha = .05, inherit.aes = FALSE)+
  geom_point(aes(x = coords.x1, y = coords.x2, # this is the init transparent frame
                 frame = start_date,
                 cumulative = TRUE),
             data = start_date, alpha = 0, inherit.aes = FALSE) +
  geom_point(aes(x = coords.x1, y = coords.x2, # this is the final transparent frames
                 frame = start_date,
                 cumulative = TRUE),
             data = date_dengue, alpha = 0, inherit.aes = FALSE) +
  # Here comes the gganimate specific bits
  labs(title = 'Day: {frame_time}') 
gganimate(map)

#========== old API ========

#https://github.com/thomasp85/gganimate
 

# ani.options(interval = 1)
#https://stackoverflow.com/questions/52510967/create-a-flyover-map-animation-using-ggmap-and-gganimate
#devtools::install_github("dgrtwo/gganimate", ref = "v0.1.1")
```
UNABLE TO RUN: System loads but wont stop, once manually stopped R Studio crashes
```{r}
# Mt <- density(dengue_3d[ ,3])
# mut <- Mt$y[findInterval(dengue_3d[ ,3], Mt$x)] * dim(dengue_3d)[1]
# h <- mse2d(as.points(dengue_3d[,1:2]), taiwan_main, nsmse = 50, range = 4)
# h <- h$h[which.min(h$mse)]
# Ms <- kernel2d(as.points(dengue_3d[ ,1:2]), taiwan_main, h = h, nx = 2000, ny = 2000)
# atx <- findInterval(x = dengue_3d[ ,1], vec = Ms$x)
# aty <- findInterval(x = dengue_3d[ ,2], vec = Ms$y)
# mhat <- NULL
# for(i in 1:length(atx)) mhat <- c(mhat, Ms$z[atx[i],aty[i]])
# u <- seq(0, 10, by = 1)
# v <- seq(0, 15, by = 1)
# mhat[is.na(mhat)] <- 0
# # g <- PCFhat(xyt = dengue_3d,  s.region = taiwan_main)
# # stik <- STIKhat(xyt = dengue_3d, s.region = taiwan_main,infectious=TRUE)
# 
# stik <- STIKhat(xyt = dengue_3d, s.region = taiwan_main, t.region = c(1, 200),lambda =mhat*mut/dim(dengue_3d)[1], dist = u, times = v, infectious = TRUE)
# g <- PCFhat(xyt = dengue_3d, lambda = mhat * mut / dim(dengue_3d)[1], dist = 1:20,times = 1:20, s.region = taiwan_main, t.region = c(1, 200))
# 
# 
# plotK(stik)
# plotPCF(g)
# plotPCF(g, persp = TRUE, theta = -65, phi = 35)
```

