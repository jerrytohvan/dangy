---
title: "feature-kda"
output: html_notebook
---

Setup R notebook Environment
```{r setup, include=TRUE, eval=TRUE,message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)
Sys.setlocale("LC_CTYPE", "en_US.UTF-8")
```

#Package load for Project
```{r}

# require(installr)
# install.ImageMagick()

packages = c("sp","sf","tidyverse","tmap","rjson", "rgdal", "geojsonio", "GISTools",'spatialEco', "raster","dplyr", "spatstat",
             'maptools', 'leaflet', 'magick', 'purrr') 
for (p in packages){
  if(!require(p, character.only = T)){
    install.packages(p) 
  } 
  library(p,character.only = T) 
}
```

#Importing Taiwan GDAM Subzone
Shapefile Object with Spatial data
Import data for past 12 years

Requires translation of chinese character independetly (https://stat.ethz.ch/pipermail/r-sig-geo/2009-March/005323.html)

Taiwan follows EPSG 3826 (http://spatialreference.org/ref/epsg/twd97-tm2-zone-121/)
```{r}
taiwan_ts_map_sp <- readOGR(dsn = "data/TAIWAN_TOWNSHIP", layer = "TOWN_MOI_1071226", stringsAsFactors=TRUE)

#taiwan <- readShapePoly("data/taiwan_data/")
taiwan <- readOGR(dsn = "data/taiwan_data", layer = "COUNTY_MOI_1071226", stringsAsFactors=TRUE)
taiwan@proj4string<- CRS( "+init=epsg:3826 +proj=longlat +ellps=WGS84 +no_defs")
taiwan.union <- aggregate(taiwan)
taiwan <- as(taiwan, "SpatialPolygons")
taiwan <- na.omit(taiwan)


df_dengue <- jsonlite::fromJSON("data/dengue_case.json") %>% 
  filter(as.Date(Onset_day) >= "2016-01-01" & as.Date(Onset_day)< "2017-01-01")

# Check for NA values for coordinates
 sum(is.na(df_dengue$Minimum_statistical_area_center_point_X))
 sum(is.na(df_dengue$Minimum_statistical_area_center_point_Y))
 df_dengue<- df_dengue[!is.na(df_dengue$Minimum_statistical_area_center_point_X),]
 df_dengue<- df_dengue[!(df_dengue$Minimum_statistical_area_center_point_X == 'None'),]
 sum(is.na(df_dengue))
 
 # Type conversion
 #df_dengue[, c(10,11,19)] <- sapply(df_dengue[, c(10,11,19)], as.numeric)
df_dengue$Minimum_statistical_area_center_point_X <- as.numeric(paste( df_dengue$Minimum_statistical_area_center_point_X))
df_dengue$Minimum_statistical_area_center_point_Y <- as.numeric(paste( df_dengue$Minimum_statistical_area_center_point_Y))
df_dengue$Determine_the_number_of_cases <- as.numeric(paste( df_dengue$Determine_the_number_of_cases))
 
  # Transform into SF object
 sf_dengue <- st_as_sf(df_dengue, 
                       coords = c("Minimum_statistical_area_center_point_X",
                                  "Minimum_statistical_area_center_point_Y"),
                        crs = "+init=epsg:3826 +proj=longlat +ellps=WGS84 +no_defs")
sf_dengue <- na.omit(sf_dengue)
sp_dengue <- as(sf_dengue, 'Spatial')
```

```{r}
sp_dengue <- as(sp_dengue, 'SpatialPoints')
```

```{r}
tmap_mode("view")
tm_shape(taiwan_ts_map_sp)+
       tm_borders(col = "grey40",alpha=0.5)+
  # prevent zoom too much
  tm_view(alpha = 1, set.zoom.limits = c(7,21))+
  tm_layout(basemaps = c('OpenStreetMap'))+
  tm_shape(sp_dengue)+
  tm_dots(col ="red",size = 0.01) 

tmap_mode("plot")
```


# Converting the generic sp format into spatstat's ppp format 

```{r echo=TRUE, eval=TRUE}
dengue_ppp <- as(sp_dengue, "ppp")
summary(dengue_ppp) 
plot(dengue_ppp)
```

# Combining  GP clinics points and the study area 
```{r echo=TRUE, eval=TRUE}
tw_owin <- as(taiwan_ts_map_sp, "owin") 
plot(tw_owin) 
summary(tw_owin)

dengueTW_ppp = dengue_ppp[tw_owin]
dengueTW_ppp <- unique(dengueTW_ppp) 
summary(dengueTW_ppp)
#plot(dengueTW_ppp)
```
```{r}
qt <- quadrat.test(dengueTW_ppp,                     
                   nx = 20, ny = 15)
```

```{r}
plot(dengueTW_ppp) 
plot(qt, add = TRUE, cex =.1) 
```

```{r}
qt
```


# Kernel Density Estimation

```{r echo=TRUE, eval=TRUE}
#dengueTW_ppp.km <- rescale(dengueTW_ppp, 1000, "km") 
kde_taiwan_bw <- density(dengueTW_ppp, sigma=0.5, edge=TRUE, kernel="gaussian")

#plot(kde_taiwan_bw)
```

```{r}
plot(kde_taiwan_bw)
```

```{r}
gridded_kde_taiwan_bw<- as.SpatialGridDataFrame.im(kde_taiwan_bw)

spplot(gridded_kde_taiwan_bw)

kde_taiwan_bw_raster <- raster(gridded_kde_taiwan_bw)
```

```{r}
tmap_mode("view")
c_osm <- tmaptools::read_osm(kde_taiwan_bw_raster, ext = 1.05)
map <- tm_shape(taiwan_ts_map_sf)+
    tm_borders(col = "grey40",alpha=0.5)+
    tm_shape(c_osm)+
    tm_rgb() +
    tm_shape(kde_taiwan_bw_raster)+
    tm_raster("v", alpha = 0.65)+ 
    tm_layout(basemaps = c('OpenStreetMap')) +
    tm_layout("Dengue Outbreak Distribution in 2016", 
            title.size = 1, 
            title.position = c("right","top"),
            legend.title.size = 1,
            legend.text.size = 0.7,
            legend.position = c("right","bottom"))
tmap_save(map, filename="plot01.png")
```

