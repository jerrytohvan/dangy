---
title: "feature-kda"
output: html_notebook
---

Setup R notebook Environment
```{r setup, include=TRUE, eval=TRUE,message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)
Sys.setlocale("LC_CTYPE", "en_US.UTF-8")
```

#Package load for Project
```{r}
packages = c("sp","sf","tidyverse","tmap","rjson", "rgdal", "geojsonio", "GISTools",'spatialEco', "raster","dplyr", "spatstat",
             'maptools', 'leaflet') 
for (p in packages){
  if(!require(p, character.only = T)){
    install.packages(p) 
  } 
  library(p,character.only = T) 
}
```

#Importing Taiwan GDAM Subzone
Shapefile Object with Spatial data
Import data for past 12 years

Requires translation of chinese character independetly (https://stat.ethz.ch/pipermail/r-sig-geo/2009-March/005323.html)

Taiwan follows EPSG 3826 (http://spatialreference.org/ref/epsg/twd97-tm2-zone-121/)
```{r}
taiwan_ts_map_sp <- readOGR(dsn = "data/TAIWAN_TOWNSHIP", layer = "TOWN_MOI_1071226", stringsAsFactors=TRUE)

#taiwan <- readShapePoly("data/taiwan_data/COUNTY_MOI_1070516.shp")
#taiwan@proj4string<- CRS( "+init=epsg:3826 +proj=longlat +ellps=WGS84 +no_defs")
#taiwan.union <- aggregate(taiwan)


df_dengue <- jsonlite::fromJSON("data/dengue_case.json") %>% 
  filter(as.Date(Onset_day) >= "1998-01-01" & as.Date(Onset_day)< "1999-01-01")

# Check for NA values for coordinates
 sum(is.na(df_dengue$Minimum_statistical_area_center_point_X))
 sum(is.na(df_dengue$Minimum_statistical_area_center_point_Y))
 df_dengue<- df_dengue[!is.na(df_dengue$Minimum_statistical_area_center_point_X),]
 df_dengue<- df_dengue[!(df_dengue$Minimum_statistical_area_center_point_X == 'None'),]
 
 # Type conversion
 df_dengue[, c(10,11,19,23,24)] <- sapply(df_dengue[, c(10,11,19,23,24)], as.numeric)
 
  # Transform into SF object
 sf_dengue <- st_as_sf(df_dengue, 
                       coords = c("Minimum_statistical_area_center_point_X",
                                  "Minimum_statistical_area_center_point_Y"),
                        crs = "+init=epsg:3826 +proj=longlat +ellps=WGS84 +no_defs",na.fail=FALSE)
sf_dengue <- na.omit(sf_dengue)
sp_dengue <- as(sf_dengue, 'Spatial')
```

```{r}
sp_dengue <- as(sp_dengue, 'SpatialPoints')
```

```{r}
tmap_mode("view")
tm_shape(taiwan_ts_map_sp)+
       tm_borders(col = "grey40",alpha=0.5)+
  # prevent zoom too much
  tm_view(alpha = 1, set.zoom.limits = c(7,21))+
  tm_layout(basemaps = c('OpenStreetMap'))+
  tm_shape(sp_dengue)+
  tm_dots(col ="red",size = 0.01) 

tmap_mode("plot")
```


# Converting the generic sp format into spatstat's ppp format 

```{r echo=TRUE, eval=TRUE}
dengue_ppp <- as(sp_dengue, "ppp")
summary(dengue_ppp) 
```

# Combining  GP clinics points and the study area 
```{r echo=TRUE, eval=TRUE}
tw_owin <- as(taiwan_ts_map_sp, "owin") 
plot(tw_owin) 
summary(tw_owin)

dengueTW_ppp = dengue_ppp[tw_owin]
summary(dengueTW_ppp)
plot(dengueTW_ppp)
```
```{r}
qt <- quadrat.test(dengueTW_ppp,                     
                   nx = 20, ny = 15)
```

```{r}
plot(dengueTW_ppp) 
plot(qt, add = TRUE, cex =.1) 
```

```{r}
qt
```


# Kernel Density Estimation

```{r echo=TRUE, eval=TRUE}
dengueTW_ppp <- rescale(dengueTW_ppp, 1000, "km") 
kde_taiwan_bw <- density(dengueTW_ppp, sigma=1.5, edge=TRUE, kernel="gaussian")

#plot(kde_taiwan_bw)
```

```{r}
plot(kde_taiwan_bw)
```

